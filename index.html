<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Press F to Pay Respects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;touch-action:manipulation}

        html,body{
            width:100%;height:100vh;height:100dvh;overflow:hidden;
            background:#060608;
            -webkit-tap-highlight-color:transparent;
            -webkit-touch-callout:none;
            -webkit-user-select:none;user-select:none;
            overscroll-behavior:none;
        }

        body{
            display:flex;flex-direction:column;
            align-items:center;justify-content:center;
            font-family:-apple-system,BlinkMacSystemFont,sans-serif;
            background:
                radial-gradient(ellipse 80% 60% at 50% 55%,#12101a 0%,#060608 100%);
        }

        /* ── canvas ── */
        #fw{
            position:fixed;top:0;left:0;width:100%;height:100%;
            pointer-events:none;z-index:10;
        }

        /* ── flash overlay ── */
        .flash{
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:radial-gradient(circle at 50% 50%,rgba(255,200,100,.22) 0%,transparent 55%);
            pointer-events:none;z-index:4;opacity:0;
            transition:opacity .06s ease;
        }
        .flash.on{opacity:1}

        /* ── layout — above canvas so button never fades ── */
        .content{
            display:flex;flex-direction:column;
            align-items:center;gap:32px;z-index:15;
            position:relative;
        }

        /* ── button ── */
        .btn-wrap{position:relative;perspective:700px}

        .btn-shadow{
            position:absolute;bottom:-12px;left:50%;
            transform:translateX(-50%);
            width:230px;height:28px;
            background:radial-gradient(ellipse,rgba(0,0,0,.65) 0%,transparent 70%);
            border-radius:50%;transition:all .1s ease;
        }
        .btn-shadow.sm{width:210px;height:20px;bottom:-8px;opacity:.7}

        .btn-base{
            width:270px;height:270px;border-radius:50%;
            background:linear-gradient(180deg,#262628 0%,#1a1a1d 40%,#101012 100%);
            display:flex;align-items:center;justify-content:center;
            box-shadow:
                0 5px 0 #000,
                0 8px 18px rgba(0,0,0,.85),
                inset 0 2px 1px rgba(255,255,255,.04),
                inset 0 -3px 6px rgba(0,0,0,.6);
        }

        .btn-rim{
            width:240px;height:240px;border-radius:50%;
            background:linear-gradient(180deg,#18181a,#0c0c0e);
            display:flex;align-items:center;justify-content:center;
            box-shadow:inset 0 3px 7px rgba(0,0,0,.9);
        }

        .btn-dome{
            width:206px;height:206px;border-radius:50%;
            background:
                radial-gradient(circle at 37% 30%,#ff6b6b 0%,#e63946 22%,#c1121f 48%,#9b0000 78%,#780000 100%);
            display:flex;align-items:center;justify-content:center;
            cursor:pointer;
            will-change:transform,box-shadow;
            touch-action:manipulation;
            transition:transform .08s ease,box-shadow .08s ease,background .08s ease;
            position:relative;
            transform:translateY(0);
            box-shadow:
                0 9px 0 #5c0000,
                0 12px 22px rgba(0,0,0,.55),
                inset 0 -7px 14px rgba(0,0,0,.38),
                inset 0 5px 10px rgba(255,255,255,.16);
        }

        /* gloss highlight — pointer-events:none so it doesn't eat touches */
        .btn-dome::after{
            content:'';position:absolute;
            top:13%;left:23%;width:36%;height:24%;
            border-radius:50%;
            background:radial-gradient(ellipse,rgba(255,255,255,.28) 0%,transparent 100%);
            transform:rotate(-18deg);
            transition:opacity .08s ease;
            pointer-events:none;
        }

        /* pressed state */
        .btn-dome.hit{
            transform:translateY(7px);
            background:
                radial-gradient(circle at 42% 38%,#ff5252 0%,#d62839 22%,#a4161a 48%,#800000 78%,#660000 100%);
            box-shadow:
                0 2px 0 #5c0000,
                0 3px 8px rgba(0,0,0,.55),
                inset 0 -3px 8px rgba(0,0,0,.4),
                inset 0 2px 5px rgba(255,255,255,.1);
        }
        .btn-dome.hit::after{opacity:.45}

        /* idle pulse */
        @keyframes glow{
            0%,100%{filter:drop-shadow(0 0 0 transparent)}
            50%{filter:drop-shadow(0 0 22px rgba(230,57,70,.35))}
        }
        .btn-dome:not(.hit){animation:glow 3s ease-in-out infinite}

        .f{
            font-family:'Outfit',sans-serif;
            font-size:86px;font-weight:900;
            color:#fff;
            text-shadow:0 2px 6px rgba(0,0,0,.35);
            line-height:1;position:relative;z-index:1;
        }

        .sub{
            color:rgba(255,255,255,.25);
            font-size:13px;letter-spacing:4px;
            text-transform:uppercase;font-weight:300;
        }

        /* ── banner ── */
        .banner{
            position:fixed;top:0;left:0;width:100%;height:100%;
            display:flex;align-items:flex-start;justify-content:center;
            padding-top:min(10vh,60px);
            z-index:20;pointer-events:none;
            opacity:0;transition:opacity 1.2s ease;
        }
        .banner.show{opacity:1}

        .banner-box{
            text-align:center;
            padding:28px 52px;
            background:linear-gradient(180deg,rgba(6,6,8,.82),rgba(6,6,8,.65));
            border-top:2px solid rgba(212,175,55,.45);
            border-bottom:2px solid rgba(212,175,55,.45);
            backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
        }

        .banner-txt{
            font-family:'Outfit',sans-serif;
            font-size:clamp(26px,5.8vw,54px);
            font-weight:900;
            color:#d4af37;
            text-shadow:
                0 0 22px rgba(212,175,55,.5),
                0 0 44px rgba(212,175,55,.18);
            letter-spacing:3px;line-height:1.35;
        }

        /* ── mobile portrait ── */
        @media(max-width:480px){
            .btn-base{width:230px;height:230px}
            .btn-rim{width:204px;height:204px}
            .btn-dome{width:174px;height:174px}
            .btn-shadow{width:195px}
            .f{font-size:68px}
            .sub{font-size:11px;letter-spacing:3px}
            .banner-box{padding:20px 28px}
        }

        /* ── mobile landscape — shrink everything so banner + button don't overlap ── */
        @media(max-height:500px) and (orientation:landscape){
            .content{gap:10px}
            .btn-base{width:150px;height:150px}
            .btn-rim{width:133px;height:133px}
            .btn-dome{width:112px;height:112px}
            .btn-shadow{width:130px;height:18px;bottom:-8px}
            .f{font-size:44px}
            .sub{font-size:9px;letter-spacing:2px}
            .banner{padding-top:4px}
            .banner-box{padding:8px 20px}
            .banner-txt{font-size:clamp(14px,3.5vh,24px);letter-spacing:2px}
        }
    </style>
</head>
<body>

<canvas id="fw"></canvas>
<div class="flash" id="flash"></div>

<div class="content">
    <div class="btn-wrap">
        <div class="btn-shadow" id="shadow"></div>
        <div class="btn-base">
            <div class="btn-rim">
                <div class="btn-dome" id="dome">
                    <span class="f">F</span>
                </div>
            </div>
        </div>
    </div>
    <p class="sub">Press F to Pay Respects</p>
</div>

<div class="banner" id="banner">
    <div class="banner-box">
        <div class="banner-txt">RIP Justin (Zhiyi) Kuang</div>
    </div>
</div>

<script>
/* ════════════════════════════════════════════
   CANVAS
   ════════════════════════════════════════════ */
const C = document.getElementById('fw');
const X = C.getContext('2d');
function resize(){C.width=innerWidth;C.height=innerHeight}
addEventListener('resize',resize);
addEventListener('orientationchange',()=>setTimeout(resize,150));
resize();

/* ════════════════════════════════════════════
   AUDIO  (Web Audio API — no files needed)
   Two buses: a.destination (quiet fireworks), muBus (loud music)
   ════════════════════════════════════════════ */
let ac,muBus;
function audio(){
    if(!ac){
        ac=new(AudioContext||webkitAudioContext)();
        muBus=ac.createGain();muBus.gain.value=1.0;
        muBus.connect(ac.destination);
    }
    if(ac.state==='suspended') ac.resume();
    return ac;
}

function noise(len,shape){
    const a=audio(),b=a.createBuffer(1,a.sampleRate*len,a.sampleRate),d=b.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*shape(i/d.length);
    return b;
}

/* mechanical click → a.destination */
function sndClick(){
    const a=audio(),t=a.currentTime;
    const o1=a.createOscillator(),g1=a.createGain();
    o1.frequency.setValueAtTime(1500,t);
    o1.frequency.exponentialRampToValueAtTime(300,t+.015);
    g1.gain.setValueAtTime(.35,t);
    g1.gain.exponentialRampToValueAtTime(.001,t+.035);
    o1.connect(g1);g1.connect(a.destination);o1.start(t);o1.stop(t+.04);
    const o2=a.createOscillator(),g2=a.createGain();
    o2.type='sine';o2.frequency.value=90;
    g2.gain.setValueAtTime(.25,t);
    g2.gain.exponentialRampToValueAtTime(.001,t+.07);
    o2.connect(g2);g2.connect(a.destination);o2.start(t);o2.stop(t+.08);
    const s=a.createBufferSource();
    s.buffer=noise(.025,p=>Math.pow(1-p,5));
    const bp=a.createBiquadFilter();bp.type='bandpass';bp.frequency.value=3500;bp.Q.value=1.5;
    const g3=a.createGain();g3.gain.setValueAtTime(.3,t);
    s.connect(bp);bp.connect(g3);g3.connect(a.destination);s.start(t);
}

function sndLaunch(){
    const a=audio(),t=a.currentTime;
    const o=a.createOscillator(),g=a.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(280+Math.random()*80,t);
    o.frequency.exponentialRampToValueAtTime(1100+Math.random()*500,t+.38);
    g.gain.setValueAtTime(.09,t);
    g.gain.exponentialRampToValueAtTime(.001,t+.38);
    o.connect(g);g.connect(a.destination);o.start(t);o.stop(t+.4);
    const s=a.createBufferSource();s.buffer=noise(.28,p=>Math.pow(1-p,1.6)*.25);
    const hp=a.createBiquadFilter();hp.type='highpass';hp.frequency.value=2200;
    const g2=a.createGain();g2.gain.setValueAtTime(.06,t);
    s.connect(hp);hp.connect(g2);g2.connect(a.destination);s.start(t);
}

function sndBoom(){
    const a=audio(),t=a.currentTime;
    const s=a.createBufferSource();
    s.buffer=noise(.55,p=>Math.pow(1-p,1.2));
    const lp=a.createBiquadFilter();lp.type='lowpass';
    lp.frequency.setValueAtTime(1200,t);
    lp.frequency.exponentialRampToValueAtTime(60,t+.5);
    const g=a.createGain();
    g.gain.setValueAtTime(.55+Math.random()*.2,t);
    g.gain.exponentialRampToValueAtTime(.001,t+.55);
    s.connect(lp);lp.connect(g);g.connect(a.destination);s.start(t);
    const o=a.createOscillator(),gb=a.createGain();
    o.type='sine';o.frequency.setValueAtTime(60,t);
    o.frequency.exponentialRampToValueAtTime(25,t+.3);
    gb.gain.setValueAtTime(.4,t);
    gb.gain.exponentialRampToValueAtTime(.001,t+.3);
    o.connect(gb);gb.connect(a.destination);o.start(t);o.stop(t+.35);
    setTimeout(sndCrackle,30+Math.random()*70);
}

function sndCrackle(){
    const a=audio(),n=5+Math.floor(Math.random()*7);
    for(let i=0;i<n;i++) setTimeout(()=>{
        const t=a.currentTime;
        const s=a.createBufferSource();
        s.buffer=noise(.025+Math.random()*.03,p=>Math.pow(1-p,4));
        const g=a.createGain();g.gain.setValueAtTime(.12+Math.random()*.1,t);
        s.connect(g);g.connect(a.destination);s.start(t);
    },i*(40+Math.random()*100));
}

/* ════════════════════════════════════════════
   CHINESE NATIONAL ANTHEM  义勇军进行曲
   Orchestral arrangement → muBus
   ════════════════════════════════════════════ */

/* --- Instrument voices --- */

// Brass (trumpets) — sawtooth + square, lowpass filtered
function brass(freq,start,dur){
    const a=audio(),t=start;
    const o1=a.createOscillator();o1.type='sawtooth';o1.frequency.value=freq;
    const o2=a.createOscillator();o2.type='square';o2.frequency.value=freq*1.001;
    const flt=a.createBiquadFilter();flt.type='lowpass';flt.frequency.value=2800;flt.Q.value=1.5;
    const mg=a.createGain();mg.gain.value=.25;
    const sg=a.createGain();sg.gain.value=.08;
    const env=a.createGain();
    env.gain.setValueAtTime(0,t);
    env.gain.linearRampToValueAtTime(.9,t+.035);
    env.gain.setValueAtTime(.8,t+dur-.05);
    env.gain.linearRampToValueAtTime(0,t+dur);
    o1.connect(mg);o2.connect(sg);mg.connect(flt);sg.connect(flt);
    flt.connect(env);env.connect(muBus);
    o1.start(t);o2.start(t);o1.stop(t+dur+.02);o2.stop(t+dur+.02);
}

// Strings (violins) — detuned sawtooths with vibrato, highpass filtered for shimmer
function strings(freq,start,dur,vol){
    const a=audio(),t=start,v=vol||.1;
    // 3 detuned oscillators for rich ensemble
    for(let d=-4;d<=4;d+=4){
        const o=a.createOscillator();o.type='sawtooth';o.frequency.value=freq+d;
        // vibrato LFO
        const lfo=a.createOscillator();lfo.type='sine';lfo.frequency.value=4.5+Math.random();
        const lfog=a.createGain();lfog.gain.value=2.5;
        lfo.connect(lfog);lfog.connect(o.frequency);
        const flt=a.createBiquadFilter();flt.type='lowpass';flt.frequency.value=3500;flt.Q.value=.7;
        const env=a.createGain();
        env.gain.setValueAtTime(0,t);
        env.gain.linearRampToValueAtTime(v/3,t+.08);
        env.gain.setValueAtTime(v/3*.85,t+dur-.06);
        env.gain.linearRampToValueAtTime(0,t+dur);
        o.connect(flt);flt.connect(env);env.connect(muBus);
        o.start(t);lfo.start(t);o.stop(t+dur+.02);lfo.stop(t+dur+.02);
    }
}

// French horn — square + triangle mix, warm lowpass
function horn(freq,start,dur,vol){
    const a=audio(),t=start,v=vol||.12;
    const o1=a.createOscillator();o1.type='square';o1.frequency.value=freq;
    const o2=a.createOscillator();o2.type='triangle';o2.frequency.value=freq*.999;
    const flt=a.createBiquadFilter();flt.type='lowpass';flt.frequency.value=1200;flt.Q.value=1;
    const mg=a.createGain();mg.gain.value=v*.6;
    const tg=a.createGain();tg.gain.value=v*.5;
    const env=a.createGain();
    env.gain.setValueAtTime(0,t);
    env.gain.linearRampToValueAtTime(1,t+.06);
    env.gain.setValueAtTime(.8,t+dur-.06);
    env.gain.linearRampToValueAtTime(0,t+dur);
    o1.connect(mg);o2.connect(tg);mg.connect(flt);tg.connect(flt);
    flt.connect(env);env.connect(muBus);
    o1.start(t);o2.start(t);o1.stop(t+dur+.02);o2.stop(t+dur+.02);
}

// Timpani hit — sine burst + noise burst
function timpani(freq,start,vol){
    const a=audio(),t=start,v=vol||.25;
    const o=a.createOscillator();o.type='sine';
    o.frequency.setValueAtTime(freq,t);
    o.frequency.exponentialRampToValueAtTime(freq*.7,t+.4);
    const env=a.createGain();
    env.gain.setValueAtTime(v,t);
    env.gain.exponentialRampToValueAtTime(.001,t+.6);
    o.connect(env);env.connect(muBus);o.start(t);o.stop(t+.65);
    // attack transient
    const s=a.createBufferSource();s.buffer=noise(.06,p=>Math.pow(1-p,6));
    const lp=a.createBiquadFilter();lp.type='lowpass';lp.frequency.value=300;
    const ng=a.createGain();ng.gain.setValueAtTime(v*.4,t);
    s.connect(lp);lp.connect(ng);ng.connect(muBus);s.start(t);
}

// Cellos/Bass — triangle with subtle warmth
function bass(freq,start,dur,vol){
    const a=audio(),t=start,v=vol||.14;
    const o=a.createOscillator();o.type='triangle';o.frequency.value=freq;
    const o2=a.createOscillator();o2.type='sine';o2.frequency.value=freq;
    const flt=a.createBiquadFilter();flt.type='lowpass';flt.frequency.value=600;
    const mg=a.createGain();mg.gain.value=v*.7;
    const sg=a.createGain();sg.gain.value=v*.5;
    const env=a.createGain();
    env.gain.setValueAtTime(0,t);
    env.gain.linearRampToValueAtTime(1,t+.05);
    env.gain.setValueAtTime(.85,t+dur-.05);
    env.gain.linearRampToValueAtTime(0,t+dur);
    o.connect(mg);o2.connect(sg);mg.connect(flt);sg.connect(flt);
    flt.connect(env);env.connect(muBus);
    o.start(t);o2.start(t);o.stop(t+dur+.02);o2.stop(t+dur+.02);
}

// Cymbals — noise burst, highpass
function cymbal(start,vol){
    const a=audio(),t=start,v=vol||.1;
    const s=a.createBufferSource();s.buffer=noise(1,p=>Math.pow(1-p,.5));
    const hp=a.createBiquadFilter();hp.type='highpass';hp.frequency.value=5500;
    const env=a.createGain();
    env.gain.setValueAtTime(v,t);
    env.gain.exponentialRampToValueAtTime(.001,t+.9);
    s.connect(hp);hp.connect(env);env.connect(muBus);s.start(t);
}

// Snare drum — bandpass noise + tone pop
function snare(start,vol){
    const a=audio(),t=start,v=vol||.18;
    const s=a.createBufferSource();s.buffer=noise(.12,p=>Math.pow(1-p,2.5));
    const bp=a.createBiquadFilter();bp.type='bandpass';bp.frequency.value=3000;bp.Q.value=.8;
    const env=a.createGain();
    env.gain.setValueAtTime(v,t);
    env.gain.exponentialRampToValueAtTime(.001,t+.12);
    s.connect(bp);bp.connect(env);env.connect(muBus);s.start(t);
    const o=a.createOscillator();o.type='triangle';
    o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(120,t+.04);
    const og=a.createGain();og.gain.setValueAtTime(v*.5,t);
    og.gain.exponentialRampToValueAtTime(.001,t+.06);
    o.connect(og);og.connect(muBus);o.start(t);o.stop(t+.08);
}

let musicOn=false;
function playMusic(){
    if(musicOn) return;
    musicOn=true;
    const a=audio(),t0=a.currentTime+.15;
    muBus.gain.cancelScheduledValues(t0);
    muBus.gain.setValueAtTime(1.0,t0);

    const BPM=108;
    const Q=60/BPM; // quarter note ≈ 0.556s

    // Note frequencies — key of F major
    const F2=87.31,C3=130.81,F3=174.61,G3=196,A3=220,Bb3=233.08,
          C4=261.63,D4=293.66,E4=329.63,F4=349.23,G4=392,A4=440,C5=523.25,F5=698.46;

    // ── Grand fanfare: F → A → C ──
    // big orchestral hits ascending through F major triad
    [[F3,0,.9],[F4,0,.9]].forEach(([f,b,d])=>{brass(f,t0+b*Q,d*Q);strings(f,t0+b*Q,d*Q,.1);});
    [[A3,1,.9],[A4,1,.9]].forEach(([f,b,d])=>{brass(f,t0+b*Q,d*Q);strings(f,t0+b*Q,d*Q,.1);});
    [[C4,2,.9],[C5,2,.9]].forEach(([f,b,d])=>{brass(f,t0+b*Q,d*Q);strings(f,t0+b*Q,d*Q,.1);});
    horn(F3,t0,Q*.9,.16);horn(A3,t0+Q,Q*.9,.14);horn(C4,t0+Q*2,Q*.9,.16);
    timpani(F2,t0,.3);timpani(F2,t0+Q,.25);timpani(F2,t0+Q*2,.3);
    cymbal(t0,.12);cymbal(t0+Q*2,.1);
    snare(t0+Q*.5,.12);snare(t0+Q*1.5,.12);snare(t0+Q*2.5,.14);

    const S=3; // melody starts beat 3 (after fanfare)

    // 义勇军进行曲 in F major — full anthem from intro
    // [freq, startBeat, durationBeats]
    const mel=[
        // 起来！不愿做奴隶的人们！
        [C4,S+0,.45],[C4,S+.5,.45],[C4,S+1,.45],
        [A3,S+1.5,1.4],[C4,S+3,.45],
        [D4,S+3.5,1.9],
        [D4,S+5.5,.45],[C4,S+6,.4],[A3,S+6.5,.4],[C4,S+7,.45],
        [G3,S+7.5,2.4],
        // 把我们的血肉，筑成我们新的长城！
        [G3,S+10,.45],[A3,S+10.5,.45],
        [C4,S+11,.4],[C4,S+11.5,.4],[C4,S+12,.4],[D4,S+12.5,.2],[C4,S+12.75,.2],
        [A3,S+13,1.9],
        [A3,S+15,.4],[G3,S+15.5,.4],[A3,S+16,.4],[C4,S+16.5,.45],
        [F3,S+17,2.4],
        // 中华民族到了最危险的时候，
        [C4,S+19.5,.45],[C4,S+20,.45],[C4,S+20.5,.45],
        [A3,S+21,1.4],[C4,S+22.5,.45],
        [D4,S+23,1.9],
        [D4,S+25,.45],[C4,S+25.5,.4],[A3,S+26,.4],[C4,S+26.5,.45],
        [G3,S+27,1.9],
        // 每个人被迫着发出最后的吼声！
        [G3,S+29,.45],[A3,S+29.5,.45],
        [C4,S+30,.4],[C4,S+30.5,.4],[D4,S+31,.4],[C4,S+31.5,.4],
        [A3,S+32,.45],[A3,S+32.5,.45],
        [G3,S+33,.4],[A3,S+33.5,.4],[C4,S+34,.45],
        [F3,S+34.5,1.4],
        // 起来！起来！起来！
        [C4,S+36,1.9],
        [C4,S+38,1.9],
        [D4,S+40,1.9],
        // 我们万众一心，
        [F4,S+42,.9],[E4,S+43,.4],[D4,S+43.5,.4],[C4,S+44,.9],
        // 冒着敌人的炮火，前进！
        [D4,S+45,.4],[C4,S+45.5,.4],[D4,S+46,.9],
        [G4,S+47,1.9],
        // 冒着敌人的炮火，前进！前进！前进 进！
        [D4,S+49,.4],[C4,S+49.5,.4],[D4,S+50,.9],
        [G4,S+51,1.9],
        [F4,S+53,1.9],
        [C4,S+55,.9],
        [F4,S+56,2.9],
    ];

    // --- Brass: main melody ---
    mel.forEach(([f,b,d])=>brass(f,t0+b*Q,d*Q));

    // --- Strings: melody doubled up an octave ---
    mel.forEach(([f,b,d])=>strings(f*2,t0+b*Q,d*Q,.08));

    // --- Strings: sustained harmony pads ---
    const pads=[
        [[F3,A3,C4],S+0,3.4],
        [[D4,A3],S+3.5,2],
        [[D4,A3,C4],S+5.5,2],
        [[G3,D4],S+7.5,2.4],
        [[C4,G3],S+10,3],
        [[A3,C4],S+13,2],
        [[F3,A3,C4],S+15,4.5],
        [[F3,A3,C4],S+19.5,3.4],
        [[D4,A3],S+23,2],
        [[G3,D4,C4],S+25,2],
        [[G3,D4],S+27,2],
        [[C4,G3,A3],S+29,3],
        [[A3,C4],S+32,2],
        [[F3,A3,C4],S+34,2],
        // 起来 — massive chords
        [[C4,G3,E4],S+36,2],
        [[C4,F3,A3],S+38,2],
        [[D4,A3,F4],S+40,2],
        [[F4,C4,A3],S+42,3],
        [[D4,A3,F3],S+45,2],
        [[G4,D4],S+47,2],
        [[D4,F3,A3],S+49,2],
        [[G4,D4,C4],S+51,2],
        [[F4,C4,A3],S+53,2],
        [[F4,C4,A3,F3],S+55,4],
    ];
    pads.forEach(([notes,b,d])=>{
        notes.forEach(f=>strings(f,t0+b*Q,d*Q,.055));
    });

    // --- French horns ---
    const hn=[
        [F3,S+0,3.4,.14],[A3,S+3.5,2,.12],
        [G3,S+7.5,2.4,.12],[C3,S+10,3,.12],
        [F3,S+13,2,.12],[F3,S+17,2.4,.14],
        [F3,S+19.5,3.4,.14],[A3,S+23,2,.12],
        [G3,S+27,2,.12],[C4,S+30,2,.12],
        [F3,S+34.5,1.5,.14],
        // 起来 — horns fortissimo
        [C4,S+36,1.9,.18],[C4,S+38,1.9,.18],[D4,S+40,1.9,.2],
        [C4,S+42,3,.16],[A3,S+45,2,.14],
        [D4,S+47,2,.16],[A3,S+49,2,.14],
        [D4,S+51,2,.16],[C4,S+53,2,.16],
        [C4,S+55,.9,.16],[A3,S+56,2.9,.18],
    ];
    hn.forEach(([f,b,d,v])=>horn(f,t0+b*Q,d*Q,v));

    // --- Bass (cellos/contrabass) ---
    const bl=[
        [F2,S+0,3.4],[F2,S+3.5,2],[G3*.5,S+7.5,2.4],[C3,S+10,3],
        [F2,S+13,2],[F2,S+15,2],[F2,S+17,2.4],
        [F2,S+19.5,3.4],[F2,S+23,2],[G3*.5,S+27,2],[C3,S+29,3],
        [F2,S+32,2],[F2,S+34.5,1.5],
        [C3,S+36,2],[C3,S+38,2],[D4*.5,S+40,2],
        [F2,S+42,3],[F2,S+45,2],[G3*.5,S+47,2],
        [F2,S+49,2],[G3*.5,S+51,2],[F2,S+53,2],[F2,S+55,4],
    ];
    bl.forEach(([f,b,d])=>bass(f,t0+b*Q,d*Q,.16));

    // --- Timpani on strong beats ---
    [S+0,S+3.5,S+7.5,S+10,S+13,S+17,S+19.5,S+23,S+27,S+29,S+34.5,
     S+36,S+38,S+40,S+42,S+45,S+47,S+49,S+51,S+53,S+56]
    .forEach(b=>timpani(F2,t0+b*Q,.25));

    // --- Snare on off-beats (march feel) ---
    for(let b=S;b<S+59;b+=2) snare(t0+(b+1)*Q,.14);

    // --- Cymbal crashes at key moments ---
    [S+0,S+7.5,S+17,S+34.5,S+36,S+40,S+47,S+51,S+56]
    .forEach(b=>cymbal(t0+b*Q,.1));

    // reset flag after anthem ends
    setTimeout(()=>{musicOn=false;},((S+59)*Q)*1000);
}

function stopMusic(){
    if(!muBus) return;
    musicOn=false;
    const a=audio(),t=a.currentTime;
    muBus.gain.cancelScheduledValues(t);
    muBus.gain.setValueAtTime(muBus.gain.value,t);
    muBus.gain.linearRampToValueAtTime(0,t+.5);
}

/* ════════════════════════════════════════════
   F-SHAPE DEFINITION (for shaped bursts)
   ════════════════════════════════════════════ */
const F_MAP=[
    "FFFFF",
    "F    ",
    "F    ",
    "FFFF ",
    "F    ",
    "F    ",
    "F    ",
];
const F_PTS=[];
for(let y=0;y<F_MAP.length;y++)
    for(let x=0;x<F_MAP[y].length;x++)
        if(F_MAP[y][x]==='F') F_PTS.push([x-2, y-3]);
// 14 anchor points, centered around (0,0)

/* ════════════════════════════════════════════
   FIREWORKS ENGINE
   ════════════════════════════════════════════ */
const shells=[], pts=[];
const fGlyphs=[]; // fading "F" text overlays

/* ── rate limiter ── */
const MAX_PTS=800, MAX_SHELLS=12, MAX_GLYPHS=6;
// returns 0–1 budget factor: 1 = plenty of room, 0 = at cap
function budget(){return Math.max(0,1-pts.length/MAX_PTS);}

const PAL=[
    [255,70,70],[70,160,255],[255,210,50],[70,255,120],
    [200,70,255],[255,120,200],[255,255,235],[255,150,50],
    [100,255,255],[255,80,140],[255,200,150],[180,255,180]
];
const rPal=()=>PAL[Math.random()*PAL.length|0];

class Shell{
    constructor(){
        this.x=C.width*(.1+Math.random()*.8);
        this.y=C.height+4;
        this.ty=C.height*(.06+Math.random()*.3);
        this.vy=-(12+Math.random()*6);
        this.vx=(Math.random()-.5)*2.5;
        this.col=rPal();this.trail=[];this.ok=true;
    }
    tick(){
        this.trail.push({x:this.x,y:this.y});
        if(this.trail.length>12)this.trail.shift();
        this.x+=this.vx;this.y+=this.vy;this.vy+=.14;
        if(this.y<=this.ty||this.vy>=0){this.boom();this.ok=false;}
    }
    draw(){
        for(let i=0;i<this.trail.length;i++){
            const t=this.trail[i],a=i/this.trail.length*.45;
            X.beginPath();X.arc(t.x,t.y,1+a*2,0,Math.PI*2);
            X.fillStyle=`rgba(255,210,140,${a})`;X.fill();
        }
        X.beginPath();X.arc(this.x,this.y,3,0,Math.PI*2);
        X.fillStyle='rgba(255,240,200,.95)';X.fill();
    }
    boom(){
        const c2=rPal();
        sndBoom();
        const b=budget(); // 0–1 how much room we have
        if(b<.05) return; // at cap, just play sound

        // floating F glyph (capped)
        if(fGlyphs.length<MAX_GLYPHS)
            fGlyphs.push({x:this.x,y:this.y,life:1,sz:70+Math.random()*80,col:this.col});

        // faster decay when loaded so particles clear sooner
        const dBoost=b<.4?(.02*(1-b)):0;
        const isF=Math.random()<.55;

        if(isF){
            const scale=35+Math.random()*25;
            // scale cluster size by budget: 2–6 instead of 6–9 when loaded
            const baseClust=Math.max(2,Math.round((6+Math.random()*4)*b));
            for(let p=0;p<F_PTS.length;p++){
                if(pts.length>=MAX_PTS) break;
                const [fx,fy]=F_PTS[p];
                const tx=fx*scale,ty=fy*scale;
                for(let j=0;j<baseClust;j++){
                    if(pts.length>=MAX_PTS) break;
                    const jx=(Math.random()-.5)*scale*.4;
                    const jy=(Math.random()-.5)*scale*.4;
                    const dx=tx+jx,dy=ty+jy;
                    const spd=Math.sqrt(dx*dx+dy*dy)/(.22*60);
                    const ang=Math.atan2(dy,dx);
                    const c=Math.random()>.3?this.col:c2;
                    pts.push({
                        x:this.x,y:this.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                        life:1,decay:.005+Math.random()*.01+dBoost,col:c,
                        sz:2+Math.random()*2.5,g:.018+Math.random()*.012,
                        fr:.975+Math.random()*.015,tw:Math.random()>.75,trail:[]
                    });
                }
            }
            // scatter fill — scale by budget
            const scatterN=Math.round(40*b);
            for(let i=0;i<scatterN&&pts.length<MAX_PTS;i++){
                const ang=Math.random()*Math.PI*2;
                const spd=1+Math.random()*4;
                pts.push({
                    x:this.x,y:this.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                    life:1,decay:.008+Math.random()*.015+dBoost,col:this.col,
                    sz:1.5+Math.random()*1.5,g:.02+Math.random()*.015,
                    fr:.98+Math.random()*.012,tw:Math.random()>.6,trail:[]
                });
            }
        } else {
            // traditional burst — scale count by budget
            const n=Math.round((80+Math.random()*60)*Math.max(b,.3))|0;
            const kind=Math.random();
            for(let i=0;i<n&&pts.length<MAX_PTS;i++){
                let ang=Math.random()*Math.PI*2,spd,c;
                if(kind<.3){spd=3+Math.random()*7;c=this.col;}
                else if(kind<.55){spd=4+Math.random()*4;c=this.col;}
                else if(kind<.8){spd=3+Math.random()*6.5;c=Math.random()>.5?this.col:c2;}
                else{ang=(i/n)*Math.PI*2+(Math.random()-.5)*.14;spd=4.5+Math.random()*2;c=this.col;}
                pts.push({
                    x:this.x,y:this.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                    life:1,decay:.004+Math.random()*.011+dBoost,col:c,
                    sz:2+Math.random()*3,g:.02+Math.random()*.016,
                    fr:.982+Math.random()*.014,tw:Math.random()>.7,trail:[]
                });
            }
        }

        // glitter core — scale by budget
        const glitN=Math.round(12*b);
        for(let i=0;i<glitN&&pts.length<MAX_PTS;i++){
            const a=Math.random()*Math.PI*2,s=.3+Math.random()*.7;
            pts.push({
                x:this.x,y:this.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,
                life:1,decay:.015+Math.random()*.02,col:[255,255,220],
                sz:.8+Math.random()*1.2,g:.008,fr:.99,tw:true,trail:[]
            });
        }
    }
}

/* render loop */
(function loop(){
    requestAnimationFrame(loop);
    X.clearRect(0,0,C.width,C.height);

    // shells
    for(let i=shells.length;i--;){
        shells[i].tick();shells[i].draw();
        if(!shells[i].ok) shells.splice(i,1);
    }

    // particles — adaptive quality based on count
    const pc=pts.length;
    const maxTrail=pc>600?3:pc>400?5:10;  // shorter trails when busy
    const drawGlow=pc<500;                  // skip glow when busy
    for(let i=pc;i--;){
        const p=pts[i];
        p.trail.push({x:p.x,y:p.y});
        if(p.trail.length>maxTrail)p.trail.shift();
        p.x+=p.vx;p.y+=p.vy;p.vy+=p.g;p.vx*=p.fr;p.vy*=p.fr;
        p.life-=p.decay;
        if(p.life<=0){pts.splice(i,1);continue;}
        const[r,g,b]=p.col;
        let v=1;if(p.tw&&Math.random()>.7)v=.25;
        for(let j=0;j<p.trail.length;j++){
            const t=p.trail[j],ta=j/p.trail.length*p.life*.35*v;
            X.beginPath();X.arc(t.x,t.y,p.sz*.5*p.life,0,Math.PI*2);
            X.fillStyle=`rgba(${r},${g},${b},${ta})`;X.fill();
        }
        const sz=p.sz*Math.max(p.life,.2);
        X.beginPath();X.arc(p.x,p.y,sz,0,Math.PI*2);
        X.fillStyle=`rgba(${r},${g},${b},${p.life*v})`;X.fill();
        if(drawGlow){
            X.beginPath();X.arc(p.x,p.y,sz*3,0,Math.PI*2);
            X.fillStyle=`rgba(${r},${g},${b},${p.life*.12*v})`;X.fill();
        }
    }

    // fading F glyphs at explosion sites
    for(let i=fGlyphs.length;i--;){
        const f=fGlyphs[i];
        f.life-=.006;
        f.y-=.15; // drift up slowly
        if(f.life<=0){fGlyphs.splice(i,1);continue;}
        const[r,g,b]=f.col;
        X.save();
        X.font=`900 ${f.sz}px Outfit,sans-serif`;
        X.textAlign='center';X.textBaseline='middle';
        // outer glow
        X.fillStyle=`rgba(${r},${g},${b},${f.life*.08})`;
        X.fillText('F',f.x,f.y);
        // core
        X.fillStyle=`rgba(${r},${g},${b},${f.life*.18})`;
        X.fillText('F',f.x,f.y);
        X.restore();
    }
})();

/* ════════════════════════════════════════════
   BUTTON
   ════════════════════════════════════════════ */
const dome=document.getElementById('dome');
const ban=document.getElementById('banner');
const fl=document.getElementById('flash');
const sh=document.getElementById('shadow');
let bannerHide;

function fire(){
    dome.classList.add('hit');
    sh.classList.add('sm');
    fl.classList.add('on');
    setTimeout(()=>fl.classList.remove('on'),140);

    // click sound + anthem
    sndClick();
    playMusic();

    // grander fireworks — 6 waves, more shells
    const W=[
        {n:4,d:0,   gap:120},
        {n:5,d:500, gap:150},
        {n:4,d:1100,gap:130},
        {n:5,d:1800,gap:110},
        {n:6,d:2600,gap:100},
        {n:7,d:3500,gap:80},
    ];
    W.forEach(w=>{for(let i=0;i<w.n;i++)
        setTimeout(()=>{if(shells.length<MAX_SHELLS){shells.push(new Shell());sndLaunch();}},w.d+i*w.gap);
    });

    // show banner, fade after 10s
    clearTimeout(bannerHide);
    ban.classList.add('show');
    bannerHide=setTimeout(()=>{ban.classList.remove('show');stopMusic();},10000);
}

function up(){dome.classList.remove('hit');sh.classList.remove('sm');}

/* — init audio on first interaction (iOS requirement) — */
function warmAudio(){
    audio();
    document.removeEventListener('touchstart',warmAudio);
    document.removeEventListener('pointerdown',warmAudio);
}
document.addEventListener('touchstart',warmAudio,{passive:true});
document.addEventListener('pointerdown',warmAudio,{passive:true});

/* — touch events (primary on mobile) — */
dome.addEventListener('touchstart',e=>{e.preventDefault();fire();},{passive:false});
dome.addEventListener('touchend',e=>{e.preventDefault();up();},{passive:false});
dome.addEventListener('touchcancel',up);

/* — pointer/mouse events (desktop + fallback) — */
let usingTouch=false;
dome.addEventListener('pointerdown',e=>{
    if(e.pointerType==='touch'){usingTouch=true;return;} // handled by touch events
    e.preventDefault();fire();
});
dome.addEventListener('pointerup',e=>{
    if(usingTouch){usingTouch=false;return;}
    e.preventDefault();up();
});
dome.addEventListener('pointerleave',e=>{if(!usingTouch)up();});
dome.addEventListener('pointercancel',up);
dome.addEventListener('contextmenu',e=>e.preventDefault());

/* keyboard: literally "Press F" */
const held=new Set();
document.addEventListener('keydown',e=>{
    if((e.key==='f'||e.key==='F')&&!held.has('f')){held.add('f');fire();}
});
document.addEventListener('keyup',e=>{
    if(e.key==='f'||e.key==='F'){held.delete('f');up();}
});
</script>
</body>
</html>
