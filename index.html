<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Press F to Pay Respects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;touch-action:manipulation}

        html,body{
            width:100%;height:100vh;height:100dvh;overflow:hidden;
            background:#060608;
            -webkit-tap-highlight-color:transparent;
            -webkit-touch-callout:none;
            -webkit-user-select:none;user-select:none;
            overscroll-behavior:none;
        }

        body{
            display:flex;flex-direction:column;
            align-items:center;justify-content:center;
            font-family:-apple-system,BlinkMacSystemFont,sans-serif;
            background:
                radial-gradient(ellipse 80% 60% at 50% 55%,#12101a 0%,#060608 100%);
        }

        /* ── canvas ── */
        #fw{
            position:fixed;top:0;left:0;width:100%;height:100%;
            pointer-events:none;z-index:10;
        }

        /* ── flash overlay ── */
        .flash{
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:radial-gradient(circle at 50% 50%,rgba(255,200,100,.22) 0%,transparent 55%);
            pointer-events:none;z-index:4;opacity:0;
            transition:opacity .06s ease;
        }
        .flash.on{opacity:1}

        /* ── layout — above canvas so button never fades ── */
        .content{
            display:flex;flex-direction:column;
            align-items:center;gap:32px;z-index:15;
            position:relative;
        }

        /* ── button ── */
        .btn-wrap{position:relative;perspective:700px}

        .btn-shadow{
            position:absolute;bottom:-12px;left:50%;
            transform:translateX(-50%);
            width:230px;height:28px;
            background:radial-gradient(ellipse,rgba(0,0,0,.65) 0%,transparent 70%);
            border-radius:50%;transition:all .1s ease;
        }
        .btn-shadow.sm{width:210px;height:20px;bottom:-8px;opacity:.7}

        .btn-base{
            width:270px;height:270px;border-radius:50%;
            background:linear-gradient(180deg,#262628 0%,#1a1a1d 40%,#101012 100%);
            display:flex;align-items:center;justify-content:center;
            box-shadow:
                0 5px 0 #000,
                0 8px 18px rgba(0,0,0,.85),
                inset 0 2px 1px rgba(255,255,255,.04),
                inset 0 -3px 6px rgba(0,0,0,.6);
        }

        .btn-rim{
            width:240px;height:240px;border-radius:50%;
            background:linear-gradient(180deg,#18181a,#0c0c0e);
            display:flex;align-items:center;justify-content:center;
            box-shadow:inset 0 3px 7px rgba(0,0,0,.9);
        }

        .btn-dome{
            width:206px;height:206px;border-radius:50%;
            background:
                radial-gradient(circle at 37% 30%,#ff6b6b 0%,#e63946 22%,#c1121f 48%,#9b0000 78%,#780000 100%);
            display:flex;align-items:center;justify-content:center;
            cursor:pointer;
            will-change:transform,box-shadow;
            touch-action:manipulation;
            transition:transform .08s ease,box-shadow .08s ease,background .08s ease;
            position:relative;
            transform:translateY(0);
            box-shadow:
                0 9px 0 #5c0000,
                0 12px 22px rgba(0,0,0,.55),
                inset 0 -7px 14px rgba(0,0,0,.38),
                inset 0 5px 10px rgba(255,255,255,.16);
        }

        /* gloss highlight — pointer-events:none so it doesn't eat touches */
        .btn-dome::after{
            content:'';position:absolute;
            top:13%;left:23%;width:36%;height:24%;
            border-radius:50%;
            background:radial-gradient(ellipse,rgba(255,255,255,.28) 0%,transparent 100%);
            transform:rotate(-18deg);
            transition:opacity .08s ease;
            pointer-events:none;
        }

        /* pressed state */
        .btn-dome.hit{
            transform:translateY(7px);
            background:
                radial-gradient(circle at 42% 38%,#ff5252 0%,#d62839 22%,#a4161a 48%,#800000 78%,#660000 100%);
            box-shadow:
                0 2px 0 #5c0000,
                0 3px 8px rgba(0,0,0,.55),
                inset 0 -3px 8px rgba(0,0,0,.4),
                inset 0 2px 5px rgba(255,255,255,.1);
        }
        .btn-dome.hit::after{opacity:.45}

        /* idle pulse */
        @keyframes glow{
            0%,100%{filter:drop-shadow(0 0 0 transparent)}
            50%{filter:drop-shadow(0 0 22px rgba(230,57,70,.35))}
        }
        .btn-dome:not(.hit){animation:glow 3s ease-in-out infinite}

        .f{
            font-family:'Outfit',sans-serif;
            font-size:86px;font-weight:900;
            color:#fff;
            text-shadow:0 2px 6px rgba(0,0,0,.35);
            line-height:1;position:relative;z-index:1;
        }

        .sub{
            color:rgba(255,255,255,.25);
            font-size:13px;letter-spacing:4px;
            text-transform:uppercase;font-weight:300;
        }

        /* ── banner ── */
        .banner{
            position:fixed;top:0;left:0;width:100%;height:100%;
            display:flex;align-items:flex-start;justify-content:center;
            padding-top:min(10vh,60px);
            z-index:20;pointer-events:none;
            opacity:0;transition:opacity 1.2s ease;
        }
        .banner.show{opacity:1}

        .banner-box{
            text-align:center;
            padding:28px 52px;
            background:linear-gradient(180deg,rgba(6,6,8,.82),rgba(6,6,8,.65));
            border-top:2px solid rgba(212,175,55,.45);
            border-bottom:2px solid rgba(212,175,55,.45);
            backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
        }

        .banner-txt{
            font-family:'Outfit',sans-serif;
            font-size:clamp(26px,5.8vw,54px);
            font-weight:900;
            color:#d4af37;
            text-shadow:
                0 0 22px rgba(212,175,55,.5),
                0 0 44px rgba(212,175,55,.18);
            letter-spacing:3px;line-height:1.35;
        }

        /* ── mobile ── */
        @media(max-width:480px){
            .btn-base{width:230px;height:230px}
            .btn-rim{width:204px;height:204px}
            .btn-dome{width:174px;height:174px}
            .btn-shadow{width:195px}
            .f{font-size:68px}
            .sub{font-size:11px;letter-spacing:3px}
            .banner-box{padding:20px 28px}
        }
    </style>
</head>
<body>

<canvas id="fw"></canvas>
<div class="flash" id="flash"></div>

<div class="content">
    <div class="btn-wrap">
        <div class="btn-shadow" id="shadow"></div>
        <div class="btn-base">
            <div class="btn-rim">
                <div class="btn-dome" id="dome">
                    <span class="f">F</span>
                </div>
            </div>
        </div>
    </div>
    <p class="sub">Press F to Pay Respects</p>
</div>

<div class="banner" id="banner">
    <div class="banner-box">
        <div class="banner-txt">RIP Justin (Zhiyi) Kuang</div>
    </div>
</div>

<script>
/* ════════════════════════════════════════════
   CANVAS
   ════════════════════════════════════════════ */
const C = document.getElementById('fw');
const X = C.getContext('2d');
function resize(){C.width=innerWidth;C.height=innerHeight}
addEventListener('resize',resize);
addEventListener('orientationchange',()=>setTimeout(resize,150));
resize();

/* ════════════════════════════════════════════
   AUDIO  (Web Audio API — no files needed)
   Two buses: fxBus (quiet fireworks), muBus (loud music)
   ════════════════════════════════════════════ */
let ac,fxBus,muBus;
function audio(){
    if(!ac){
        ac=new(AudioContext||webkitAudioContext)();
        fxBus=ac.createGain();fxBus.gain.value=0.12;
        fxBus.connect(ac.destination);
        muBus=ac.createGain();muBus.gain.value=1.0;
        muBus.connect(ac.destination);
    }
    if(ac.state==='suspended') ac.resume();
    return ac;
}

function noise(len,shape){
    const a=audio(),b=a.createBuffer(1,a.sampleRate*len,a.sampleRate),d=b.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*shape(i/d.length);
    return b;
}

/* mechanical click → fxBus */
function sndClick(){
    const a=audio(),t=a.currentTime;
    const o1=a.createOscillator(),g1=a.createGain();
    o1.frequency.setValueAtTime(1500,t);
    o1.frequency.exponentialRampToValueAtTime(300,t+.015);
    g1.gain.setValueAtTime(.35,t);
    g1.gain.exponentialRampToValueAtTime(.001,t+.035);
    o1.connect(g1);g1.connect(fxBus);o1.start(t);o1.stop(t+.04);
    const o2=a.createOscillator(),g2=a.createGain();
    o2.type='sine';o2.frequency.value=90;
    g2.gain.setValueAtTime(.25,t);
    g2.gain.exponentialRampToValueAtTime(.001,t+.07);
    o2.connect(g2);g2.connect(fxBus);o2.start(t);o2.stop(t+.08);
    const s=a.createBufferSource();
    s.buffer=noise(.025,p=>Math.pow(1-p,5));
    const bp=a.createBiquadFilter();bp.type='bandpass';bp.frequency.value=3500;bp.Q.value=1.5;
    const g3=a.createGain();g3.gain.setValueAtTime(.3,t);
    s.connect(bp);bp.connect(g3);g3.connect(fxBus);s.start(t);
}

function sndLaunch(){
    const a=audio(),t=a.currentTime;
    const o=a.createOscillator(),g=a.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(280+Math.random()*80,t);
    o.frequency.exponentialRampToValueAtTime(1100+Math.random()*500,t+.38);
    g.gain.setValueAtTime(.09,t);
    g.gain.exponentialRampToValueAtTime(.001,t+.38);
    o.connect(g);g.connect(fxBus);o.start(t);o.stop(t+.4);
    const s=a.createBufferSource();s.buffer=noise(.28,p=>Math.pow(1-p,1.6)*.25);
    const hp=a.createBiquadFilter();hp.type='highpass';hp.frequency.value=2200;
    const g2=a.createGain();g2.gain.setValueAtTime(.06,t);
    s.connect(hp);hp.connect(g2);g2.connect(fxBus);s.start(t);
}

function sndBoom(){
    const a=audio(),t=a.currentTime;
    const s=a.createBufferSource();
    s.buffer=noise(.55,p=>Math.pow(1-p,1.2));
    const lp=a.createBiquadFilter();lp.type='lowpass';
    lp.frequency.setValueAtTime(1200,t);
    lp.frequency.exponentialRampToValueAtTime(60,t+.5);
    const g=a.createGain();
    g.gain.setValueAtTime(.55+Math.random()*.2,t);
    g.gain.exponentialRampToValueAtTime(.001,t+.55);
    s.connect(lp);lp.connect(g);g.connect(fxBus);s.start(t);
    const o=a.createOscillator(),gb=a.createGain();
    o.type='sine';o.frequency.setValueAtTime(60,t);
    o.frequency.exponentialRampToValueAtTime(25,t+.3);
    gb.gain.setValueAtTime(.4,t);
    gb.gain.exponentialRampToValueAtTime(.001,t+.3);
    o.connect(gb);gb.connect(fxBus);o.start(t);o.stop(t+.35);
    setTimeout(sndCrackle,30+Math.random()*70);
}

function sndCrackle(){
    const a=audio(),n=5+Math.floor(Math.random()*7);
    for(let i=0;i<n;i++) setTimeout(()=>{
        const t=a.currentTime;
        const s=a.createBufferSource();
        s.buffer=noise(.025+Math.random()*.03,p=>Math.pow(1-p,4));
        const g=a.createGain();g.gain.setValueAtTime(.12+Math.random()*.1,t);
        s.connect(g);g.connect(fxBus);s.start(t);
    },i*(40+Math.random()*100));
}

/* ════════════════════════════════════════════
   CHINESE INSTRUMENTAL MUSIC (synthesized)
   Erhu melody + guzheng plucks in A minor pentatonic (Yu mode)
   ════════════════════════════════════════════ */
let musicOn=false;

/* erhu — sawtooth + vibrato + filter → muBus */
function erhu(freq,start,dur){
    const a=audio(),t=start;
    const osc=a.createOscillator();osc.type='sawtooth';
    osc.frequency.setValueAtTime(freq,t);
    // vibrato
    const lfo=a.createOscillator(),ld=a.createGain();
    lfo.frequency.value=5.5;ld.gain.value=freq*.018;
    lfo.connect(ld);ld.connect(osc.frequency);
    // portamento slides
    osc.frequency.setValueAtTime(freq*.985,t);
    osc.frequency.linearRampToValueAtTime(freq,t+.12);
    // filter
    const flt=a.createBiquadFilter();flt.type='lowpass';
    flt.frequency.value=1600;flt.Q.value=2.5;
    // envelope
    const env=a.createGain();
    const atk=Math.min(.15,dur*.15);
    env.gain.setValueAtTime(0,t);
    env.gain.linearRampToValueAtTime(.28,t+atk);
    env.gain.setValueAtTime(.28,t+dur-.35);
    env.gain.linearRampToValueAtTime(0,t+dur);
    osc.connect(flt);flt.connect(env);env.connect(muBus);
    osc.start(t);lfo.start(t);osc.stop(t+dur+.01);lfo.stop(t+dur+.01);
}

/* guzheng pluck — triangle + harmonics + attack noise → muBus */
function guzheng(freq,start){
    const a=audio(),t=start;
    const o1=a.createOscillator();o1.type='triangle';o1.frequency.value=freq;
    const o2=a.createOscillator();o2.type='sine';o2.frequency.value=freq*2;
    const o3=a.createOscillator();o3.type='sine';o3.frequency.value=freq*3;
    const g1=a.createGain();g1.gain.setValueAtTime(.18,t);g1.gain.exponentialRampToValueAtTime(.001,t+2.5);
    const g2=a.createGain();g2.gain.setValueAtTime(.06,t);g2.gain.exponentialRampToValueAtTime(.001,t+1.5);
    const g3=a.createGain();g3.gain.setValueAtTime(.025,t);g3.gain.exponentialRampToValueAtTime(.001,t+.8);
    o1.connect(g1);g1.connect(muBus);
    o2.connect(g2);g2.connect(muBus);
    o3.connect(g3);g3.connect(muBus);
    o1.start(t);o2.start(t);o3.start(t);
    o1.stop(t+3);o2.stop(t+2);o3.stop(t+1);
    // pluck noise
    const ns=a.createBufferSource();ns.buffer=noise(.015,p=>Math.pow(1-p,4));
    const ng=a.createGain();ng.gain.setValueAtTime(.07,t);
    const hp=a.createBiquadFilter();hp.type='highpass';hp.frequency.value=1500;
    ns.connect(hp);hp.connect(ng);ng.connect(muBus);ns.start(t);
}

/* drone pad for atmosphere → muBus */
function drone(freq,start,dur){
    const a=audio(),t=start;
    const o=a.createOscillator();o.type='sine';o.frequency.value=freq;
    const o2=a.createOscillator();o2.type='sine';o2.frequency.value=freq*1.002;// slight detune
    const flt=a.createBiquadFilter();flt.type='lowpass';flt.frequency.value=600;
    const g=a.createGain();
    g.gain.setValueAtTime(0,t);
    g.gain.linearRampToValueAtTime(.06,t+2);
    g.gain.setValueAtTime(.06,t+dur-3);
    g.gain.linearRampToValueAtTime(0,t+dur);
    o.connect(flt);o2.connect(flt);flt.connect(g);g.connect(muBus);
    o.start(t);o2.start(t);o.stop(t+dur+.1);o2.stop(t+dur+.1);
}

function playMusic(){
    if(musicOn) return;
    musicOn=true;
    const a=audio(),t0=a.currentTime+.15;
    const B=60/52; // ~1.15s per beat at 52 BPM

    // Note frequencies (A minor pentatonic / Yu mode)
    const A3=220,C4=261.63,D4=293.66,E4=329.63,G3=196,G4=392,A4=440,E3=164.81;

    // ── erhu melody: [freq, startBeat, durationBeats] ──
    const mel=[
        [E4,0,3],[D4,3.5,2],[C4,6,3.5],
        [A3,10.5,2.5],[C4,13.5,1.5],[D4,15.5,2.5],[C4,18.5,2],[A3,21,4],
        [E4,26,2],[G4,28.5,3.5],[E4,32.5,2],[D4,35,3.5],
        [C4,39.5,2.5],[D4,42.5,1.5],[C4,44.5,2.5],[A3,47.5,5],
    ];
    mel.forEach(([f,b,d])=>erhu(f,t0+b*B,d*B));

    // ── guzheng accompaniment: [freq, startBeat] ──
    const gz=[
        [A3,0],[E4,.6],
        [A3,6],[C4,6.5],
        [E3,10.5],[A3,10.9],
        [C4,13.5],[A3,13.9],
        [E3,21],[A3,21.4],
        [G3,26],[E4,26.5],
        [A3,28.5],[C4,28.9],
        [A3,32.5],[D4,32.9],
        [A3,35],[G3,35.4],
        [A3,39.5],[E4,39.9],
        [C4,42.5],[A3,42.9],
        [E3,47.5],[A3,47.9],[E4,48.3],
    ];
    gz.forEach(([f,b])=>guzheng(f,t0+b*B));

    // ── low drone on A2/E3 ──
    drone(110,t0,53*B);
    drone(E3,t0+10*B,43*B);

    const total=53*B*1000;
    setTimeout(()=>{musicOn=false;},total);
}

/* ════════════════════════════════════════════
   F-SHAPE DEFINITION (for shaped bursts)
   ════════════════════════════════════════════ */
const F_MAP=[
    "FFFFF",
    "F    ",
    "F    ",
    "FFFF ",
    "F    ",
    "F    ",
    "F    ",
];
const F_PTS=[];
for(let y=0;y<F_MAP.length;y++)
    for(let x=0;x<F_MAP[y].length;x++)
        if(F_MAP[y][x]==='F') F_PTS.push([x-2, y-3]);
// 14 anchor points, centered around (0,0)

/* ════════════════════════════════════════════
   FIREWORKS ENGINE
   ════════════════════════════════════════════ */
const shells=[], pts=[];
const fGlyphs=[]; // fading "F" text overlays

const PAL=[
    [255,70,70],[70,160,255],[255,210,50],[70,255,120],
    [200,70,255],[255,120,200],[255,255,235],[255,150,50],
    [100,255,255],[255,80,140],[255,200,150],[180,255,180]
];
const rPal=()=>PAL[Math.random()*PAL.length|0];

class Shell{
    constructor(){
        this.x=C.width*(.1+Math.random()*.8);
        this.y=C.height+4;
        this.ty=C.height*(.06+Math.random()*.3);
        this.vy=-(12+Math.random()*6);
        this.vx=(Math.random()-.5)*2.5;
        this.col=rPal();this.trail=[];this.ok=true;
    }
    tick(){
        this.trail.push({x:this.x,y:this.y});
        if(this.trail.length>12)this.trail.shift();
        this.x+=this.vx;this.y+=this.vy;this.vy+=.14;
        if(this.y<=this.ty||this.vy>=0){this.boom();this.ok=false;}
    }
    draw(){
        for(let i=0;i<this.trail.length;i++){
            const t=this.trail[i],a=i/this.trail.length*.45;
            X.beginPath();X.arc(t.x,t.y,1+a*2,0,Math.PI*2);
            X.fillStyle=`rgba(255,210,140,${a})`;X.fill();
        }
        X.beginPath();X.arc(this.x,this.y,3,0,Math.PI*2);
        X.fillStyle='rgba(255,240,200,.95)';X.fill();
    }
    boom(){
        const c2=rPal();
        sndBoom();

        // floating F glyph
        fGlyphs.push({
            x:this.x, y:this.y, life:1,
            sz:70+Math.random()*80,
            col:this.col
        });

        // decide burst type: 55% F-shaped, 45% traditional
        const isF = Math.random() < .55;

        if(isF){
            // F-shaped burst
            const scale = 18 + Math.random()*14; // px per grid unit
            const timeK = .22; // arrival ~0.22s
            for(let p=0;p<F_PTS.length;p++){
                const [fx,fy]=F_PTS[p];
                const tx=fx*scale, ty=fy*scale;
                // spawn cluster of 6-9 particles per anchor point
                const clust=6+Math.floor(Math.random()*4);
                for(let j=0;j<clust;j++){
                    const jx=(Math.random()-.5)*scale*.4;
                    const jy=(Math.random()-.5)*scale*.4;
                    const dx=tx+jx, dy=ty+jy;
                    const spd=Math.sqrt(dx*dx+dy*dy)/(.22*60);
                    const ang=Math.atan2(dy,dx);
                    const c=Math.random()>.3?this.col:c2;
                    pts.push({
                        x:this.x,y:this.y,
                        vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                        life:1,decay:.005+Math.random()*.01,col:c,
                        sz:2+Math.random()*2.5,g:.018+Math.random()*.012,
                        fr:.975+Math.random()*.015,tw:Math.random()>.75,trail:[]
                    });
                }
            }
            // scatter fill particles for density
            for(let i=0;i<40;i++){
                const ang=Math.random()*Math.PI*2;
                const spd=1+Math.random()*4;
                pts.push({
                    x:this.x,y:this.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                    life:1,decay:.008+Math.random()*.015,col:this.col,
                    sz:1.5+Math.random()*1.5,g:.02+Math.random()*.015,
                    fr:.98+Math.random()*.012,tw:Math.random()>.6,trail:[]
                });
            }
        } else {
            // traditional grand burst — more particles, bigger
            const n=130+Math.random()*90|0;
            const kind=Math.random();
            for(let i=0;i<n;i++){
                let ang=Math.random()*Math.PI*2,spd,c;
                if(kind<.3){spd=3+Math.random()*7;c=this.col;}
                else if(kind<.55){spd=4+Math.random()*4;c=this.col;}
                else if(kind<.8){spd=3+Math.random()*6.5;c=Math.random()>.5?this.col:c2;}
                else{ang=(i/n)*Math.PI*2+(Math.random()-.5)*.14;spd=4.5+Math.random()*2;c=this.col;}
                pts.push({
                    x:this.x,y:this.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                    life:1,decay:.004+Math.random()*.011,col:c,
                    sz:2+Math.random()*3,g:.02+Math.random()*.016,
                    fr:.982+Math.random()*.014,tw:Math.random()>.7,trail:[]
                });
            }
        }

        // glitter core (always)
        for(let i=0;i<20;i++){
            const a=Math.random()*Math.PI*2,s=.3+Math.random()*.7;
            pts.push({
                x:this.x,y:this.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,
                life:1,decay:.015+Math.random()*.02,col:[255,255,220],
                sz:.8+Math.random()*1.2,g:.008,fr:.99,tw:true,trail:[]
            });
        }
    }
}

/* render loop */
(function loop(){
    requestAnimationFrame(loop);
    X.fillStyle='rgba(6,6,8,.13)';
    X.fillRect(0,0,C.width,C.height);

    // shells
    for(let i=shells.length;i--;){
        shells[i].tick();shells[i].draw();
        if(!shells[i].ok) shells.splice(i,1);
    }

    // particles
    for(let i=pts.length;i--;){
        const p=pts[i];
        p.trail.push({x:p.x,y:p.y});
        if(p.trail.length>6)p.trail.shift();
        p.x+=p.vx;p.y+=p.vy;p.vy+=p.g;p.vx*=p.fr;p.vy*=p.fr;
        p.life-=p.decay;
        if(p.life<=0){pts.splice(i,1);continue;}
        const[r,g,b]=p.col;
        let v=1;if(p.tw&&Math.random()>.7)v=.25;
        for(let j=0;j<p.trail.length;j++){
            const t=p.trail[j],ta=j/p.trail.length*p.life*.35*v;
            X.beginPath();X.arc(t.x,t.y,p.sz*.5*p.life,0,Math.PI*2);
            X.fillStyle=`rgba(${r},${g},${b},${ta})`;X.fill();
        }
        const sz=p.sz*Math.max(p.life,.2);
        X.beginPath();X.arc(p.x,p.y,sz,0,Math.PI*2);
        X.fillStyle=`rgba(${r},${g},${b},${p.life*v})`;X.fill();
        X.beginPath();X.arc(p.x,p.y,sz*3,0,Math.PI*2);
        X.fillStyle=`rgba(${r},${g},${b},${p.life*.12*v})`;X.fill();
    }

    // fading F glyphs at explosion sites
    for(let i=fGlyphs.length;i--;){
        const f=fGlyphs[i];
        f.life-=.006;
        f.y-=.15; // drift up slowly
        if(f.life<=0){fGlyphs.splice(i,1);continue;}
        const[r,g,b]=f.col;
        X.save();
        X.font=`900 ${f.sz}px Outfit,sans-serif`;
        X.textAlign='center';X.textBaseline='middle';
        // outer glow
        X.fillStyle=`rgba(${r},${g},${b},${f.life*.08})`;
        X.fillText('F',f.x,f.y);
        // core
        X.fillStyle=`rgba(${r},${g},${b},${f.life*.18})`;
        X.fillText('F',f.x,f.y);
        X.restore();
    }
})();

/* ════════════════════════════════════════════
   BUTTON
   ════════════════════════════════════════════ */
const dome=document.getElementById('dome');
const ban=document.getElementById('banner');
const fl=document.getElementById('flash');
const sh=document.getElementById('shadow');
let bannerHide;

function fire(){
    dome.classList.add('hit');
    sh.classList.add('sm');
    fl.classList.add('on');
    setTimeout(()=>fl.classList.remove('on'),140);

    // click sound + music
    sndClick();
    playMusic();

    // grander fireworks — 6 waves, more shells
    const W=[
        {n:4,d:0,   gap:120},
        {n:5,d:500, gap:150},
        {n:4,d:1100,gap:130},
        {n:5,d:1800,gap:110},
        {n:6,d:2600,gap:100},
        {n:7,d:3500,gap:80},
    ];
    W.forEach(w=>{for(let i=0;i<w.n;i++)
        setTimeout(()=>{shells.push(new Shell());sndLaunch();},w.d+i*w.gap);
    });

    // show banner, fade after 10s
    clearTimeout(bannerHide);
    ban.classList.add('show');
    bannerHide=setTimeout(()=>ban.classList.remove('show'),10000);
}

function up(){dome.classList.remove('hit');sh.classList.remove('sm');}

/* — init audio on first interaction (iOS requirement) — */
function warmAudio(){
    audio();
    document.removeEventListener('touchstart',warmAudio);
    document.removeEventListener('pointerdown',warmAudio);
}
document.addEventListener('touchstart',warmAudio,{passive:true});
document.addEventListener('pointerdown',warmAudio,{passive:true});

/* — touch events (primary on mobile) — */
dome.addEventListener('touchstart',e=>{e.preventDefault();fire();},{passive:false});
dome.addEventListener('touchend',e=>{e.preventDefault();up();},{passive:false});
dome.addEventListener('touchcancel',up);

/* — pointer/mouse events (desktop + fallback) — */
let usingTouch=false;
dome.addEventListener('pointerdown',e=>{
    if(e.pointerType==='touch'){usingTouch=true;return;} // handled by touch events
    e.preventDefault();fire();
});
dome.addEventListener('pointerup',e=>{
    if(usingTouch){usingTouch=false;return;}
    e.preventDefault();up();
});
dome.addEventListener('pointerleave',e=>{if(!usingTouch)up();});
dome.addEventListener('pointercancel',up);
dome.addEventListener('contextmenu',e=>e.preventDefault());

/* keyboard: literally "Press F" */
const held=new Set();
document.addEventListener('keydown',e=>{
    if((e.key==='f'||e.key==='F')&&!held.has('f')){held.add('f');fire();}
});
document.addEventListener('keyup',e=>{
    if(e.key==='f'||e.key==='F'){held.delete('f');up();}
});
</script>
</body>
</html>
